name: Auto Create Branch and PR on Label

on:
  issues:
    types: [labeled]

jobs:
  create-branch-and-pr:
    if: github.event.label.name == 'ready-for-dev'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse Issue and Create Branch/PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const issueBody = context.payload.issue.body || '';
            const issueTitle = context.payload.issue.title || '';

            // Feature Branch ì„¹ì…˜ì—ì„œ ë¸Œëœì¹˜ëª… ì¶”ì¶œ
            const branchRegex = /##\s*ğŸŒ³\s*Feature\s+Branch[^]*?Branch\s*ëª…:\s*`([^`]+)`/i;
            const branchMatch = issueBody.match(branchRegex);

            if (!branchMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âš ï¸ Feature Branch ì„¹ì…˜ì—ì„œ ë¸Œëœì¹˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Issue bodyì— ë‹¤ìŒ í˜•ì‹ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”:\n\n```\n## ğŸŒ³ Feature Branch\n- Branch ëª…: `{issue-number}-{short-description}`\n```'
              });
              core.setFailed('ë¸Œëœì¹˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            const branchName = branchMatch[1].trim();
            console.log(`ì¶”ì¶œëœ ë¸Œëœì¹˜ëª…: ${branchName}`);

            // dev ë¸Œëœì¹˜ì—ì„œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
            try {
              const devRef = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/dev'
              });

              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: devRef.data.object.sha
              });

              console.log(`âœ… ë¸Œëœì¹˜ ìƒì„± ì™„ë£Œ: ${branchName}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`â„¹ï¸ ë¸Œëœì¹˜ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${branchName}`);
              } else {
                throw error;
              }
            }

            // PR ë³¸ë¬¸ ìƒì„± - Issue ë‚´ìš© ê¸°ë°˜ìœ¼ë¡œ í…œí”Œë¦¿ ì±„ìš°ê¸°
            const prBody = `## ğŸ“‹ ê°œìš”

${issueTitle}

## ğŸ”— ê´€ë ¨ ì´ìŠˆ

Closes #${issueNumber}

## ğŸ“ ë³€ê²½ì‚¬í•­

<!-- Issueì—ì„œ êµ¬í˜„í•  ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš” -->
${issueBody.includes('## âœ… ì™„ë£Œ ì¡°ê±´') ? issueBody.match(/## âœ… ì™„ë£Œ ì¡°ê±´[^]*?(?=##|$)/)?.[0] || '- ë³€ê²½ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”' : '- ë³€ê²½ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”'}

## ğŸ§ª í…ŒìŠ¤íŠ¸

${issueBody.includes('## ğŸ§ª í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­') ? issueBody.match(/## ğŸ§ª í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­[^]*?(?=##|$)/)?.[0].replace('## ğŸ§ª í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­', '') || '- [ ] í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”' : '- [ ] ìœ ë‹› í…ŒìŠ¤íŠ¸ í†µê³¼\n- [ ] í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼\n- [ ] ë¡œì»¬ í™˜ê²½ í…ŒìŠ¤íŠ¸'}

## ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (UI ë³€ê²½ ì‹œ)

| ë³€ê²½ ì „ | ë³€ê²½ í›„ |
| ------- | ------- |
| ìŠ¤í¬ë¦°ìƒ· ì¶”ê°€ | ìŠ¤í¬ë¦°ìƒ· ì¶”ê°€ |

## ğŸš€ ë°°í¬ ê³ ë ¤ì‚¬í•­

- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- [ ] í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ í•„ìš”
- [ ] ë‹¤ìš´íƒ€ì„ ë°œìƒ ê°€ëŠ¥ì„±
- [ ] ë¡¤ë°± ê³„íš ìˆ˜ë¦½

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì½”ë“œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜
- [ ] ì…€í”„ ë¦¬ë·° ì™„ë£Œ
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] ë³€ê²½ ë¡œê·¸ ì‘ì„±
`;

            // Draft PR ìƒì„±
            const prTitle = `Closes #${issueNumber} ${issueTitle}`;

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: branchName,
                base: 'dev',
                body: prBody,
                draft: true
              });

              console.log(`âœ… Draft PR ìƒì„± ì™„ë£Œ: #${pr.data.number}`);

              // Issueì— ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸš€ **ìë™ìœ¼ë¡œ ë¸Œëœì¹˜ì™€ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

ğŸ“Œ **Branch**: \`${branchName}\`
ğŸ”— **Pull Request**: #${pr.data.number}

ê°œë°œì„ ì‹œì‘í•˜ì‹œë ¤ë©´:
\`\`\`bash
git fetch origin
git checkout ${branchName}
\`\`\`

PRì´ Draft ìƒíƒœë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê°œë°œ ì™„ë£Œ í›„ "Ready for review"ë¡œ ì „í™˜í•´ì£¼ì„¸ìš”.`
              });

              // ë¼ë²¨ êµì²´: ready-for-dev ì œê±°, in-development ì¶”ê°€
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ready-for-dev'
              });

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['in-development']
                });
              } catch (error) {
                console.log('âš ï¸ in-development ë¼ë²¨ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.');
              }

            } catch (error) {
              console.error('PR ìƒì„± ì‹¤íŒ¨:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âŒ PR ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì—ëŸ¬: ${error.message}`
              });
              throw error;
            }
