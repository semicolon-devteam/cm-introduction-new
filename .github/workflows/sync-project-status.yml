name: Sync Project Status to Labels

on:
#   schedule:
#     - cron: '*/5 * * * *'  # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Sync Project Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_PAT }}
          script: |
            const query = `
              query($org: String!, $projectNumber: Int!) {
                organization(login: $org) {
                  projectV2(number: $projectNumber) {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            repository {
                              name
                              owner {
                                login
                              }
                            }
                            labels(first: 20) {
                              nodes {
                                name
                              }
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            console.log('ğŸ“Š Projects ì¡°íšŒ ì¤‘...');

            const result = await github.graphql(query, {
              org: 'semicolon-devteam',
              projectNumber: 1
            });

            const items = result.organization.projectV2.items.nodes;
            console.log(`ì´ ${items.length}ê°œ ì•„ì´í…œ í™•ì¸`);

            let processedCount = 0;
            let skippedCount = 0;

            for (const item of items) {
              if (!item.content) {
                skippedCount++;
                continue;
              }

              const issue = item.content;
              const issueNumber = issue.number;
              const repo = issue.repository.name;
              const owner = issue.repository.owner.login;

              // ì´ìŠˆì˜ í˜„ì¬ ë¼ë²¨ë“¤
              const currentLabels = issue.labels.nodes.map(l => l.name);

              // Status í•„ë“œ ì°¾ê¸°
              const statusField = item.fieldValues.nodes.find(
                fv => fv.field && fv.field.name === 'Status'
              );

              if (!statusField) {
                continue;
              }

              const statusValue = statusField.name;

              // Statusê°€ 'ê²€ìˆ˜ì™„ë£Œ'ì´ê³  ì•„ì§ ready-for-dev ë¼ë²¨ì´ ì—†ëŠ” ê²½ìš°
              if (statusValue === 'ê²€ìˆ˜ì™„ë£Œ' && !currentLabels.includes('ready-for-dev')) {
                console.log(`\nğŸ”„ ${owner}/${repo}#${issueNumber} - ë¼ë²¨ ì¶”ê°€ ì¤‘`);

                try {
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['ready-for-dev']
                  });

                  console.log(`  âœ… ready-for-dev ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ`);
                  processedCount++;
                } catch (error) {
                  if (error.status === 404) {
                    console.log(`  âš ï¸  ready-for-dev ë¼ë²¨ì´ ${repo}ì— ì—†ìŠµë‹ˆë‹¤`);
                    console.log(`     ë¼ë²¨ ìƒì„±: gh label create "ready-for-dev" --repo ${owner}/${repo}`);
                  } else {
                    console.log(`  âŒ ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
                  }
                }
              } else if (statusValue === 'ê²€ìˆ˜ì™„ë£Œ' && currentLabels.includes('ready-for-dev')) {
                skippedCount++;
              }
            }

            console.log('\n' + '='.repeat(60));
            console.log('ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:');
            console.log(`  âœ… ë¼ë²¨ ì¶”ê°€: ${processedCount}ê°œ`);
            console.log(`  â­ï¸  ìŠ¤í‚µ: ${skippedCount}ê°œ (ì´ë¯¸ ë¼ë²¨ ìˆìŒ)`);
            console.log('='.repeat(60));
