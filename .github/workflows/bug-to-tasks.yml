name: Bug to Tasks Generator

on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: "íƒ€ê²Ÿ ë ˆí¬ì§€í† ë¦¬"
        required: true
        type: choice
        options:
          - cm-land
          - cm-cointalk
          - cm-office
          - cm-jungchipan
          - cm-template
      bug_issue_number:
        description: "Bug ì´ìŠˆ ë²ˆí˜¸"
        required: true
        type: number
      auto_assign:
        description: "ë‹´ë‹¹ìž ìžë™ í• ë‹¹"
        required: false
        type: boolean
        default: true
      dry_run:
        description: "í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì‹¤ì œ ì´ìŠˆ ìƒì„± ì•ˆí•¨)"
        required: false
        type: boolean
        default: false

jobs:
  analyze-and-generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout command-center
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install

      - name: Display Input Parameters
        run: |
          echo "ðŸŽ¯ íƒ€ê²Ÿ ë ˆí¬ì§€í† ë¦¬: ${{ inputs.target_repository }}"
          echo "ðŸ› Bug ì´ìŠˆ ë²ˆí˜¸: #${{ inputs.bug_issue_number }}"
          echo "ðŸ‘¤ ìžë™ í• ë‹¹: ${{ inputs.auto_assign }}"
          echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ inputs.dry_run }}"

      - name: Fetch Bug Issue
        id: fetch_bug
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            try {
              const { data: issue } = await github.rest.issues.get({
                owner: 'semicolon-devteam',
                repo: '${{ inputs.target_repository }}',
                issue_number: ${{ inputs.bug_issue_number }}
              });

              console.log('âœ… Bug ì´ìŠˆ ì¡°íšŒ ì„±ê³µ');
              console.log('ì œëª©:', issue.title);
              console.log('ë³¸ë¬¸ ê¸¸ì´:', issue.body?.length || 0, 'ê¸€ìž');
              console.log('ë¼ë²¨:', issue.labels.map(l => l.name).join(', '));

              // Bug bodyë¥¼ íŒŒì¼ë¡œ ì €ìž¥
              fs.writeFileSync('bug-body.txt', issue.body || '');

              core.setOutput('bug_title', issue.title);
              core.setOutput('bug_number', issue.number);
              core.setOutput('bug_url', issue.html_url);
              core.setOutput('bug_labels', JSON.stringify(issue.labels.map(l => l.name)));

            } catch (error) {
              core.setFailed(`âŒ Bug ì´ìŠˆë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
              throw error;
            }

      - name: Parse Bug Report
        id: parse_bug
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const bugBody = fs.readFileSync('bug-body.txt', 'utf8');

            console.log('ðŸ“„ Bug ë³¸ë¬¸ ê¸¸ì´:', bugBody.length);

            // ê¸´ê¸‰ë„ íŒŒì‹±
            let urgency = 'medium';
            if (bugBody.includes('ðŸ”¥ ê¸´ê¸‰') || bugBody.includes('[x] ðŸ”¥ ê¸´ê¸‰')) {
              urgency = 'critical';
            } else if (bugBody.includes('ðŸš¨ ë†’ìŒ') || bugBody.includes('[x] ðŸš¨ ë†’ìŒ')) {
              urgency = 'high';
            } else if (bugBody.includes('âš¡ ë³´í†µ') || bugBody.includes('[x] âš¡ ë³´í†µ')) {
              urgency = 'medium';
            } else if (bugBody.includes('ðŸ“Œ ë‚®ìŒ') || bugBody.includes('[x] ðŸ“Œ ë‚®ìŒ')) {
              urgency = 'low';
            }

            // ë°œìƒ ë¹ˆë„ íŒŒì‹±
            let frequency = 'sometimes';
            if (bugBody.includes('[x] í•­ìƒ')) {
              frequency = 'always';
            } else if (bugBody.includes('[x] ìžì£¼')) {
              frequency = 'often';
            } else if (bugBody.includes('[x] ê°€ë”')) {
              frequency = 'sometimes';
            } else if (bugBody.includes('[x] í•œ ë²ˆë§Œ')) {
              frequency = 'once';
            }

            // ìœ„ì¹˜ íŒŒì‹±
            let location = 'unknown';
            if (bugBody.includes('[x] ì›¹ì‚¬ì´íŠ¸')) {
              location = 'web';
            } else if (bugBody.includes('[x] ëª¨ë°”ì¼ ì•±')) {
              location = 'mobile';
            } else if (bugBody.includes('[x] ê´€ë¦¬ìž íŽ˜ì´ì§€')) {
              location = 'admin';
            } else if (bugBody.includes('[x] API/ë°±ì—”ë“œ')) {
              location = 'backend';
            }

            console.log('ðŸ“Š íŒŒì‹± ê²°ê³¼:');
            console.log('- ê¸´ê¸‰ë„:', urgency);
            console.log('- ë°œìƒ ë¹ˆë„:', frequency);
            console.log('- ìœ„ì¹˜:', location);

            const parsedData = {
              urgency,
              frequency,
              location
            };

            fs.writeFileSync('bug-parsed.json', JSON.stringify(parsedData, null, 2));

            core.setOutput('urgency', urgency);
            core.setOutput('frequency', frequency);
            core.setOutput('location', location);

      - name: Analyze Bug with Claude AI
        id: claude_analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TARGET_REPO: ${{ inputs.target_repository }}
          BUG_TITLE: ${{ steps.fetch_bug.outputs.bug_title }}
          BUG_NUMBER: ${{ inputs.bug_issue_number }}
          URGENCY: ${{ steps.parse_bug.outputs.urgency }}
          FREQUENCY: ${{ steps.parse_bug.outputs.frequency }}
          LOCATION: ${{ steps.parse_bug.outputs.location }}
        run: |
          cd .github/scripts
          node analyze-bug.js
          cd ../..

          if [ -f bug-tasks-output.json ]; then
            echo "âœ… bug-tasks-output.json íŒŒì¼ ìƒì„± í™•ì¸"
            ls -lh bug-tasks-output.json
          else
            echo "::error::âŒ bug-tasks-output.json íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: Display Generated Tasks
        run: |
          echo "ðŸ¤– AIê°€ ìƒì„±í•œ Bug Fix Task ëª©ë¡"
          echo "=================================="
          echo ""

          if [ -f bug-tasks-output.json ]; then
            jq -r '.tasks[] | "[ìš°ì„ ìˆœìœ„ \(.priority)] \(.title)\n   ðŸ“‹ í…œí”Œë¦¿: \(.template)\n   â±ï¸  ìž‘ì—…ëŸ‰: \(.estimated_points)ì \n   ðŸŽ¯ ê¸´ê¸‰ë„: \(.urgency)\n   ðŸ’¡ ë¶„ì„: \(.analysis)\n"' bug-tasks-output.json
          fi

      - name: Create GitHub Issues
        id: create_issues
        if: inputs.dry_run == false
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TARGET_REPO: ${{ inputs.target_repository }}
          BUG_NUMBER: ${{ inputs.bug_issue_number }}
          BUG_TITLE: ${{ steps.fetch_bug.outputs.bug_title }}
          AUTO_ASSIGN: ${{ inputs.auto_assign }}
        run: |
          echo "ðŸš€ GitHub Issues ìƒì„± ì‹œìž‘..."

          cd .github/scripts
          node create-bug-tasks.js
          cd ../..

          if [ -f created-bug-tasks.json ]; then
            echo "ðŸ“Š ìƒì„± ê²°ê³¼:"
            cat created-bug-tasks.json | jq '.'
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: bug-tasks-results
          path: |
            bug-tasks-output.json
            bug-body.txt
            bug-parsed.json
            created-bug-tasks.json
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ› Bug to Tasks Generator ì‹¤í–‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ì‹¤í–‰ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **íƒ€ê²Ÿ ë ˆí¬**: ${{ inputs.target_repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bug ì´ìŠˆ**: [#${{ inputs.bug_issue_number }}](${{ steps.fetch_bug.outputs.bug_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **ê¸´ê¸‰ë„**: ${{ steps.parse_bug.outputs.urgency }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°œìƒ ë¹ˆë„**: ${{ steps.parse_bug.outputs.frequency }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ëª¨ë“œ**: ${{ inputs.dry_run == true && 'DRY RUN (í…ŒìŠ¤íŠ¸)' || 'PRODUCTION (ì‹¤ì œ ìƒì„±)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f bug-tasks-output.json ]; then
            TASK_COUNT=$(jq '.tasks | length' bug-tasks-output.json 2>/dev/null || echo "0")
            echo "### ðŸ¤– ìƒì„±ëœ Tasks: ${TASK_COUNT}ê°œ" >> $GITHUB_STEP_SUMMARY
          fi
