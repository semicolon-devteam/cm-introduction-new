name: Status Command (Comment)

on:
  issue_comment:
    types: [created]

jobs:
  handle-status-command:
    # /status ëª…ë ¹ì–´ë¡œ ì‹œì‘í•˜ëŠ” ì½”ë©˜íŠ¸ë§Œ ì²˜ë¦¬
    if: startsWith(github.event.comment.body, '/status ')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Process Status Command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const issueNumber = context.payload.issue.number;
            const issueNodeId = context.payload.issue.node_id;
            const owner = 'semicolon-devteam';
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            console.log(`ğŸ’¬ ì½”ë©˜íŠ¸: ${comment}`);
            console.log(`ğŸ“‹ ì´ìŠˆ #${issueNumber}`);

            // /status ë‹¤ìŒì˜ ìƒíƒœ ì¶”ì¶œ
            const statusMatch = comment.match(/^\/status\s+(.+)/);
            if (!statusMatch) {
              console.log('âš ï¸ ì˜ëª»ëœ ëª…ë ¹ì–´ í˜•ì‹');
              return;
            }

            const targetStatus = statusMatch[1].trim();
            console.log(`ğŸ¯ ëª©í‘œ Status: ${targetStatus}`);

            // í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ
            const projectQuery = `
              query($owner: String!) {
                organization(login: $owner) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      number
                      title
                      fields(first: 30) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                          ... on ProjectV2FieldCommon {
                            id
                            name
                            dataType
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(projectQuery, { owner });
            const projects = projectData.organization?.projectsV2?.nodes || [];
            const targetProject = projects.find(p => p.number === 1);

            if (!targetProject) {
              console.log('âš ï¸ í”„ë¡œì íŠ¸ #1ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: issueNumber,
                body: `âŒ í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
              });
              return;
            }

            console.log(`ğŸ“‹ í”„ë¡œì íŠ¸: ${targetProject.title}`);

            // ì´ìŠˆê°€ í”„ë¡œì íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
            const issueQuery = `
              query($issueNodeId: ID!) {
                node(id: $issueNodeId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          number
                        }
                      }
                    }
                  }
                }
              }
            `;

            const issueData = await github.graphql(issueQuery, { issueNodeId });
            const projectItem = issueData.node.projectItems.nodes.find(
              item => item.project.number === 1
            );

            if (!projectItem) {
              console.log('âš ï¸ ì´ìŠˆê°€ í”„ë¡œì íŠ¸ì— ì—†ìŠµë‹ˆë‹¤.');
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: issueNumber,
                body: `âŒ ì´ìŠˆê°€ í”„ë¡œì íŠ¸ #1ì— ì—†ìŠµë‹ˆë‹¤.`
              });
              return;
            }

            const projectItemId = projectItem.id;
            console.log(`âœ… í”„ë¡œì íŠ¸ ì•„ì´í…œ ID: ${projectItemId}`);

            // Status í•„ë“œ ë° ë‚ ì§œ í•„ë“œ ì°¾ê¸°
            const statusField = targetProject.fields.nodes.find(f => f.name === 'Status');
            const startDateField = targetProject.fields.nodes.find(f => f.name === 'ì‹œì‘ì¼');
            const endDateField = targetProject.fields.nodes.find(f => f.name === 'ì¢…ë£Œì¼');

            if (!statusField || !statusField.options) {
              console.log('âš ï¸ Status í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            // ëª©í‘œ Status ì˜µì…˜ ì°¾ê¸°
            const statusOption = statusField.options.find(o => o.name === targetStatus);
            if (!statusOption) {
              const availableStatuses = statusField.options.map(o => o.name).join(', ');
              console.log(`âŒ Status "${targetStatus}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: issueNumber,
                body: `âŒ Status \`${targetStatus}\`ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‚¬ìš© ê°€ëŠ¥í•œ Status: ${availableStatuses}`
              });
              return;
            }

            // Status ì—…ë°ì´íŠ¸
            const updateStatusMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: $value
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            await github.graphql(updateStatusMutation, {
              projectId: targetProject.id,
              itemId: projectItemId,
              fieldId: statusField.id,
              value: { singleSelectOptionId: statusOption.id }
            });

            console.log(`âœ… Status ë³€ê²½: ${targetStatus}`);

            // í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            async function updateField(fieldId, value) {
              await github.graphql(updateStatusMutation.replace('updateProjectV2ItemFieldValue', 'updateProjectV2ItemFieldValue'), {
                projectId: targetProject.id,
                itemId: projectItemId,
                fieldId: fieldId,
                value: value
              });
            }

            // Statusë³„ ìë™í™” ë¡œì§ ì‹¤í–‰
            const today = new Date().toISOString().split('T')[0];
            let automationMessage = '';

            if (targetStatus === 'ì‘ì—…ì¤‘' && startDateField) {
              // ì‹œì‘ì¼ ì„¤ì •
              await github.graphql(updateStatusMutation, {
                projectId: targetProject.id,
                itemId: projectItemId,
                fieldId: startDateField.id,
                value: { date: today }
              });
              console.log(`âœ… ì‹œì‘ì¼ ì„¤ì •: ${today}`);
              automationMessage += `\n- âœ… ì‹œì‘ì¼: ${today}`;
            }
            else if (targetStatus === 'ë¦¬ë·°ìš”ì²­') {
              // PR ê²€ì¦
              console.log('ğŸ” ë¦¬ë·°ìš”ì²­ ê²€ì¦ ì‹œì‘...');

              const { data: prs } = await github.rest.pulls.list({
                owner: repoOwner,
                repo: repoName,
                state: 'open'
              });

              const linkedPR = prs.find(pr =>
                pr.body && pr.body.includes(`#${issueNumber}`)
              );

              let validationPassed = true;
              let failureReason = '';

              if (!linkedPR) {
                validationPassed = false;
                failureReason = 'ì—°ê²°ëœ PRì´ ì—†ìŠµë‹ˆë‹¤';
              } else if (!linkedPR.requested_reviewers || linkedPR.requested_reviewers.length === 0) {
                validationPassed = false;
                failureReason = 'Reviewerê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
              }

              if (!validationPassed) {
                console.log(`âŒ ê²€ì¦ ì‹¤íŒ¨: ${failureReason}`);

                // Statusë¥¼ 'ì‘ì—…ì¤‘'ìœ¼ë¡œ ë³µê·€
                const inProgressOption = statusField.options.find(o => o.name === 'ì‘ì—…ì¤‘');
                if (inProgressOption) {
                  await github.graphql(updateStatusMutation, {
                    projectId: targetProject.id,
                    itemId: projectItemId,
                    fieldId: statusField.id,
                    value: { singleSelectOptionId: inProgressOption.id }
                  });
                  console.log('ğŸ”„ Status â†’ ì‘ì—…ì¤‘ (ìë™ ë³µê·€)');
                }

                await github.rest.issues.createComment({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: issueNumber,
                  body: `âš ï¸ **ë¦¬ë·° ìš”ì²­ ì‹¤íŒ¨**\n\n${failureReason}\n\në‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n- [ ] PRì´ ìƒì„±ë˜ì—ˆë‚˜ìš”?\n- [ ] PRì— ì´ìŠˆ ë²ˆí˜¸ê°€ ì—°ê²°ë˜ì—ˆë‚˜ìš”? (ì˜ˆ: closes #${issueNumber})\n- [ ] Reviewerê°€ ì§€ì •ë˜ì—ˆë‚˜ìš”?\n\nStatusê°€ ìë™ìœ¼ë¡œ "ì‘ì—…ì¤‘"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
                });
                return;
              } else {
                console.log('âœ… ë¦¬ë·°ìš”ì²­ ê²€ì¦ ì„±ê³µ');
                automationMessage += `\n- âœ… PR ê²€ì¦ í†µê³¼`;
              }
            }
            else if (targetStatus === 'ë³‘í•©ë¨' && endDateField) {
              // ì¢…ë£Œì¼ ì„¤ì •
              await github.graphql(updateStatusMutation, {
                projectId: targetProject.id,
                itemId: projectItemId,
                fieldId: endDateField.id,
                value: { date: today }
              });
              console.log(`âœ… ì¢…ë£Œì¼ ì„¤ì •: ${today}`);
              automationMessage += `\n- âœ… ì¢…ë£Œì¼: ${today}`;
            }

            // ì„±ê³µ ë©”ì‹œì§€
            await github.rest.issues.createComment({
              owner: repoOwner,
              repo: repoName,
              issue_number: issueNumber,
              body: `âœ… Statusê°€ **${targetStatus}**(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.${automationMessage}`
            });

            console.log('âœ¨ Status ëª…ë ¹ ì²˜ë¦¬ ì™„ë£Œ');
