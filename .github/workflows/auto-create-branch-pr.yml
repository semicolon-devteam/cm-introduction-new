name: Auto Create Branch and Draft PR

on:
  issues:
    types: [labeled]

jobs:
  create-branch-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Check Label is ready-for-dev
        id: check_label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelName = context.payload.label.name;
            const issue = context.payload.issue;

            console.log(`Label added: ${labelName}`);
            console.log(`Issue #${issue.number}: ${issue.title}`);

            // 'ready-for-dev' ë¼ë²¨ì´ ì•„ë‹ˆë©´ ì¢…ë£Œ
            if (labelName !== 'ready-for-dev') {
              console.log('Not ready-for-dev label, skipping');
              core.setOutput('should_create', 'false');
              return;
            }

            console.log('ready-for-dev label detected!');

            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ Branch ì •ë³´ ì¶”ì¶œ
            const branchMatch = issue.body.match(/> ğŸŒ¿ \*\*Branch\*\*: `(\d+-[a-z0-9-]+)`/);

            if (!branchMatch) {
              console.log('No branch name found in issue body');
              core.setOutput('should_create', 'false');

              // ë¸Œëœì¹˜ëª…ì´ ì—†ìœ¼ë©´ ì´ìŠˆì— ì½”ë©˜íŠ¸
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âš ï¸ ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ë¸Œëœì¹˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Epic/Bug to Tasksë¡œ ìƒì„±ëœ ì´ìŠˆì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.'
              });
              return;
            }

            const branchName = branchMatch[1];
            console.log(`Branch name: ${branchName}`);

            core.setOutput('should_create', 'true');
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', issue.title);
            core.setOutput('branch_name', branchName);
            core.setOutput('repo_name', context.repo.repo);
            core.setOutput('repo_owner', context.repo.owner);

      - name: Checkout Repository
        if: steps.check_label.outputs.should_create == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create Branch
        if: steps.check_label.outputs.should_create == 'true'
        id: create_branch
        run: |
          BRANCH_NAME="${{ steps.check_label.outputs.branch_name }}"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            # Create branch from dev (or main if dev doesn't exist)
            if git ls-remote --heads origin "dev" | grep -q "dev"; then
              BASE_BRANCH="dev"
            else
              BASE_BRANCH="main"
            fi

            echo "Creating branch $BRANCH_NAME from $BASE_BRANCH"
            git checkout -b "$BRANCH_NAME" "origin/$BASE_BRANCH"
            git push origin "$BRANCH_NAME"

            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Create Draft PR
        if: steps.check_label.outputs.should_create == 'true' && steps.create_branch.outputs.branch_exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branchName = '${{ steps.check_label.outputs.branch_name }}';
            const baseBranch = '${{ steps.create_branch.outputs.base_branch }}' || 'dev';
            const issueNumber = '${{ steps.check_label.outputs.issue_number }}';
            const issueTitle = '${{ steps.check_label.outputs.issue_title }}';

            // PR ì œëª©: ì´ìŠˆ ì œëª©ê³¼ ë™ì¼
            const prTitle = issueTitle;

            // PR ë³¸ë¬¸: ì´ìŠˆ ë§í¬ (Closes ëŒ€ì‹  Related to ì‚¬ìš©í•˜ì—¬ ìë™ ì¢…ë£Œ ë°©ì§€)
            const prBody = `Related to #${issueNumber}

            ## ì‘ì—… ë‚´ìš©
            <!-- ì´ PRì—ì„œ ìˆ˜í–‰í•œ ì‘ì—…ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš” -->

            ## í…ŒìŠ¤íŠ¸
            <!-- í…ŒìŠ¤íŠ¸ ë°©ë²•ì„ ì„¤ëª…í•´ì£¼ì„¸ìš” -->
            - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ë° í†µê³¼
            - [ ] í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼
            - [ ] ë¡œì»¬ í™˜ê²½ì—ì„œ ë™ì‘ í™•ì¸

            ## ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì½”ë“œ ë¦¬ë·° ì¤€ë¹„ ì™„ë£Œ
            - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ì™„ë£Œ
            - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ (í•„ìš”í•œ ê²½ìš°)

            ---
            ğŸ¤– ì´ PRì€ Task ì´ìŠˆ #${issueNumber}ì— 'ready-for-dev' ë¼ë²¨ì´ ì¶”ê°€ë˜ë©´ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            â„¹ï¸ PRì´ ë¨¸ì§€ë˜ë©´ Statusê°€ 'ë¦¬ë·°ìš”ì²­'ìœ¼ë¡œ ë³€ê²½ë˜ì§€ë§Œ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«íˆì§€ ì•ŠìŠµë‹ˆë‹¤.`;

            try {
              const { data: pr } = await github.rest.pulls.create({
                owner,
                repo,
                title: prTitle,
                head: branchName,
                base: baseBranch,
                body: prBody,
                draft: true
              });

              console.log(`âœ… Draft PR created: ${pr.html_url}`);

              // ì´ìŠˆì— PR ë§í¬ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `ğŸš€ Draft PRì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${pr.html_url}\n\në¸Œëœì¹˜: \`${branchName}\`\n\nì‘ì—…ì„ ì‹œì‘í•˜ë ¤ë©´ í•´ë‹¹ ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•˜ê³  ì½”ë“œë¥¼ ì‘ì„±í•œ í›„ PRì„ "Ready for review" ìƒíƒœë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.`
              });

              console.log('âœ… Comment added to issue');

            } catch (error) {
              console.error('Error creating PR:', error);

              // PR ìƒì„± ì‹¤íŒ¨ ì‹œ ì´ìŠˆì— ì—ëŸ¬ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `âš ï¸ Draft PR ìë™ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì—ëŸ¬: ${error.message}\n\nìˆ˜ë™ìœ¼ë¡œ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”.`
              });
            }

      - name: Comment if Branch Already Exists
        if: steps.check_label.outputs.should_create == 'true' && steps.create_branch.outputs.branch_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = '${{ steps.check_label.outputs.issue_number }}';
            const branchName = '${{ steps.check_label.outputs.branch_name }}';

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `â„¹ï¸ ë¸Œëœì¹˜ \`${branchName}\`ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸°ì¡´ PRì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œìš´ PRì„ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.`
            });
