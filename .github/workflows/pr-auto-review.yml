name: PR Auto Review

on:
  pull_request:
    types: [ready_for_review, labeled]
    branches:
      - dev
      - main
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  check-trigger:
    name: Check Review Trigger
    runs-on: ubuntu-latest
    outputs:
      should_review: ${{ steps.check.outputs.result }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check if review should run
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            const action = context.payload.action;

            console.log('ðŸ” Checking review trigger...');
            console.log('Event:', eventName);
            console.log('Action:', action);

            // /review ì½”ë©˜íŠ¸ ì²´í¬
            if (eventName === 'issue_comment' && action === 'created') {
              const comment = context.payload.comment.body.trim();
              const isPR = context.payload.issue.pull_request !== undefined;

              if (isPR && comment === '/review') {
                console.log('âœ… Trigger: /review comment');
                core.setOutput('result', 'true');
                core.setOutput('pr_number', context.payload.issue.number);
                return;
              }

              console.log('â­ï¸  Skip: Not a /review comment on PR');
              core.setOutput('result', 'false');
              return;
            }

            // ê¸°ì¡´ íŠ¸ë¦¬ê±°ë“¤
            const prNumber = context.payload.pull_request?.number;
            core.setOutput('pr_number', prNumber || '');

            // Draft â†’ Ready for review ì „í™˜
            if (action === 'ready_for_review') {
              console.log('âœ… Trigger: Ready for review');
              core.setOutput('result', 'true');
              return;
            }

            // ready-for-review ë¼ë²¨ ì¶”ê°€
            if (action === 'labeled' && context.payload.label?.name === 'ready-for-review') {
              console.log('âœ… Trigger: ready-for-review label');
              core.setOutput('result', 'true');
              return;
            }

            // re-review ë¼ë²¨ ì¶”ê°€ (ìž¬ë¦¬ë·° ìš”ì²­)
            if (action === 'labeled' && context.payload.label?.name === 're-review') {
              console.log('âœ… Trigger: re-review label');
              core.setOutput('result', 'true');
              return;
            }

            console.log('â­ï¸  Skip: Waiting for ready signal');
            core.setOutput('result', 'false');

  detect-project:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_review == 'true'
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.type }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect Project Type
        id: detect
        run: |
          if [ -f "package.json" ]; then
            if grep -q '"next"' package.json; then
              echo "type=nextjs" >> $GITHUB_OUTPUT
            else
              echo "type=react" >> $GITHUB_OUTPUT
            fi
          elif [ -f "pom.xml" ]; then
            echo "type=spring-maven" >> $GITHUB_OUTPUT
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "type=spring-gradle" >> $GITHUB_OUTPUT
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Show Detection Result
        run: |
          echo "ðŸ—ï¸ Detected project type: ${{ steps.detect.outputs.type }}"

  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    needs: detect-project
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        if: contains(needs.detect-project.outputs.project_type, 'next') || contains(needs.detect-project.outputs.project_type, 'react')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        if: contains(needs.detect-project.outputs.project_type, 'spring')
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Frontend Lint
        if: contains(needs.detect-project.outputs.project_type, 'next') || contains(needs.detect-project.outputs.project_type, 'react')
        run: |
          echo "ðŸ” Running ESLint..."
          npm ci
          npm run lint || true

          if command -v npx &> /dev/null && [ -f ".prettierrc" ]; then
            echo "ðŸŽ¨ Checking Prettier formatting..."
            npx prettier --check . || true
          fi

      - name: Backend Lint (Gradle)
        if: contains(needs.detect-project.outputs.project_type, 'spring-gradle')
        run: |
          echo "ðŸ” Running Checkstyle..."
          chmod +x ./gradlew
          ./gradlew checkstyleMain checkstyleTest || true

          if grep -q "spotless" build.gradle; then
            echo "ðŸŽ¨ Checking Spotless formatting..."
            ./gradlew spotlessCheck || true
          fi

      - name: Backend Lint (Maven)
        if: contains(needs.detect-project.outputs.project_type, 'spring-maven')
        run: |
          echo "ðŸ” Running Checkstyle..."
          mvn checkstyle:check || true

  test-coverage:
    name: Test & Coverage
    runs-on: ubuntu-latest
    needs: [detect-project, lint-and-format]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        if: contains(needs.detect-project.outputs.project_type, 'next') || contains(needs.detect-project.outputs.project_type, 'react')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        if: contains(needs.detect-project.outputs.project_type, 'spring')
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Frontend Tests
        if: contains(needs.detect-project.outputs.project_type, 'next') || contains(needs.detect-project.outputs.project_type, 'react')
        run: |
          npm ci

          if grep -q '"test"' package.json; then
            echo "ðŸ§ª Running tests..."
            npm run test -- --coverage --passWithNoTests || true
          fi

      - name: Run Backend Tests (Gradle)
        if: contains(needs.detect-project.outputs.project_type, 'spring-gradle')
        run: |
          chmod +x ./gradlew
          echo "ðŸ§ª Running tests..."
          ./gradlew test jacocoTestReport || true

      - name: Run Backend Tests (Maven)
        if: contains(needs.detect-project.outputs.project_type, 'spring-maven')
        run: |
          echo "ðŸ§ª Running tests..."
          mvn test jacoco:report || true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        continue-on-error: true
        with:
          files: |
            coverage/lcov.info
            target/site/jacoco/jacoco.xml
            build/reports/jacoco/test/jacocoTestReport.xml

  claude-review:
    name: Claude AI Review
    runs-on: ubuntu-latest
    needs: [detect-project, lint-and-format, test-coverage]
    if: always()
    steps:
      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'issue_comment') {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
            }

            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('pr_number', pr.number);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get PR Diff
        run: |
          echo "ðŸ“ Getting PR diff..."
          git fetch origin ${{ steps.pr_info.outputs.base_ref }}

          # ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì œì™¸í•˜ê³  diff ìƒì„±
          git diff origin/${{ steps.pr_info.outputs.base_ref }}...HEAD \
            --diff-filter=d \
            -- ':!*.png' ':!*.jpg' ':!*.jpeg' ':!*.gif' ':!*.svg' ':!*.webp' \
               ':!*.ico' ':!*.pdf' ':!*.woff' ':!*.woff2' ':!*.ttf' ':!*.eot' \
            > pr-diff.txt

          echo "ðŸ“Š Diff size: $(wc -l < pr-diff.txt) lines"

      - name: Install Dependencies
        run: |
          cd ${{ github.workspace }}
          # command-centerì˜ scripts ë””ë ‰í† ë¦¬ì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Fetch review script from command-center
        uses: actions/checkout@v4
        with:
          repository: semicolon-devteam/command-center
          ref: main
          path: command-center-scripts
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          sparse-checkout: |
            .github/shared-scripts/review-pr.js
          sparse-checkout-cone-mode: false

      - name: Copy review script
        run: |
          echo "ðŸ“‹ Copying review script from command-center..."

          cp command-center-scripts/.github/shared-scripts/review-pr.js review-pr.js

          # ë³µì‚¬ ì„±ê³µ í™•ì¸
          if [ ! -f review-pr.js ] || [ ! -s review-pr.js ]; then
            echo "âŒ review-pr.js ë³µì‚¬ ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… review-pr.js ì¤€ë¹„ ì™„ë£Œ ($(wc -l < review-pr.js) lines)"
          echo "ðŸ“ Script preview (first 10 lines):"
          head -10 review-pr.js

      - name: Run Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
        run: |
          echo "ðŸ¤– Running Claude AI review..."
          echo "Repository: ${{ github.repository }}"
          echo "PR Number: ${{ steps.pr_info.outputs.pr_number }}"
          node review-pr.js

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
            const prNumber = '${{ steps.pr_info.outputs.pr_number }}';

            // ë¦¬ë·° ê²°ê³¼ ì½ê¸°
            let review;
            try {
              review = JSON.parse(fs.readFileSync('review-result.json', 'utf8'));
            } catch (error) {
              console.log('âŒ ë¦¬ë·° ê²°ê³¼ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              return;
            }

            // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // í˜„ìž¬ í† í° ì‚¬ìš©ìž ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const { data: currentUser } = await github.rest.users.getAuthenticated();

            // PR ìž‘ì„±ìžì™€ í˜„ìž¬ ì‚¬ìš©ìžê°€ ê°™ì€ì§€ í™•ì¸
            const isSameUser = pullRequest.user.login === currentUser.login;

            // ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„±
            try {
              // ìžì‹ ì˜ PRì´ë©´ COMMENTë§Œ, ì•„ë‹ˆë©´ APPROVE/REQUEST_CHANGES
              let event = 'COMMENT';
              if (!isSameUser) {
                event = review.approved ? 'APPROVE' : 'REQUEST_CHANGES';
              } else {
                console.log('âš ï¸ ìžì‹ ì˜ PRì´ë¯€ë¡œ COMMENTë¡œë§Œ ìž‘ì„±í•©ë‹ˆë‹¤');
              }

              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: review.comment,
                event: event
              });

              console.log(`âœ… ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„± ì™„ë£Œ: ${review.approved ? 'APPROVE' : 'REQUEST_CHANGES'}`);
            } catch (error) {
              console.error('âŒ ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„± ì‹¤íŒ¨:', error.message);

              // ëŒ€ì²´: ì¼ë°˜ ì½”ë©˜íŠ¸ë¡œ ìž‘ì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸ¤– Claude AI Review\n\n${review.comment}`
              });
            }

      - name: Set Job Status
        if: always()
        run: |
          if [ -f "review-result.json" ]; then
            approved=$(jq -r '.approved' review-result.json)
            if [ "$approved" = "false" ]; then
              echo "âŒ ë¦¬ë·°ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              exit 1
            fi
            echo "âœ… ë¦¬ë·° í†µê³¼"
          else
            echo "âš ï¸  ë¦¬ë·° ê²°ê³¼ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

  auto-merge:
    name: Auto Merge
    runs-on: ubuntu-latest
    needs: [check-trigger, claude-review]
    if: needs.claude-review.result == 'success'
    steps:
      - name: Enable Auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            try {
              // PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
              const prNumber = '${{ needs.check-trigger.outputs.pr_number }}' ||
                               context.payload.pull_request?.number ||
                               context.payload.issue?.number;

              if (!prNumber) {
                throw new Error('PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              }

              // PR ìƒíƒœ í™•ì¸
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              console.log(`ðŸ” PR ìƒíƒœ: ${pr.state}, Mergeable: ${pr.mergeable}, Merged: ${pr.merged}`);

              if (pr.merged) {
                console.log('âœ… PRì´ ì´ë¯¸ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
              }

              if (pr.mergeable === false) {
                throw new Error('PRì— ì¶©ëŒì´ ìžˆìŠµë‹ˆë‹¤');
              }

              // ë¨¸ì§€ ì‹¤í–‰
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${prNumber})`,
                commit_message: 'Automatically merged after passing all checks'
              });

              console.log('âœ… PRì´ ìžë™ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
              console.error('âŒ ìžë™ ë¨¸ì§€ ì‹¤íŒ¨:', error.message);
              console.error('ìƒì„¸ ì—ëŸ¬:', JSON.stringify(error.response?.data || error, null, 2));

              // ìƒì„¸í•œ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
              let failureReason = 'ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ';
              if (error.message.includes('ì¶©ëŒ')) {
                failureReason = 'PRì— ë¨¸ì§€ ì¶©ëŒì´ ìžˆìŠµë‹ˆë‹¤';
              } else if (error.status === 403) {
                failureReason = 'ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (Repository Settings í™•ì¸ í•„ìš”)';
              } else if (error.status === 405) {
                failureReason = 'Squash mergeê°€ ë¹„í™œì„±í™”ë˜ì–´ ìžˆìŠµë‹ˆë‹¤ (Repository Settings â†’ Pull Requests í™•ì¸)';
              } else if (error.message.includes('required status checks')) {
                failureReason = 'Required status checksê°€ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
              }

              // ë¨¸ì§€ ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ìž‘ì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ ìžë™ ë¨¸ì§€ ì‹¤íŒ¨\n\n**ì›ì¸:** ${failureReason}\n\n**ì—ëŸ¬ ë©”ì‹œì§€:** \`${error.message}\`\n\nìˆ˜ë™ìœ¼ë¡œ ë¨¸ì§€í•´ì£¼ì„¸ìš”.`
              });

              throw error;
            }
