name: Auto Set Epic Project Fields

on:
  issues:
    types: [opened, edited]

jobs:
  set-epic-fields:
    # Epic 라벨이 있거나 제목이 [Epic]으로 시작하면 실행
    if: contains(github.event.issue.labels.*.name, 'epic') || startsWith(github.event.issue.title, '[Epic]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Set Epic Project Fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const issueNodeId = context.payload.issue.node_id;
            const owner = 'semicolon-devteam';

            // 프로젝트 조회
            const projectQuery = `
              query($owner: String!) {
                organization(login: $owner) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      number
                      title
                      fields(first: 30) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(projectQuery, { owner });
            const projects = projectData.organization?.projectsV2?.nodes || [];

            console.log(`조회된 프로젝트 수: ${projects.length}`);
            console.log(`프로젝트 목록: ${projects.map(p => `#${p.number} ${p.title}`).join(', ')}`);

            const targetProject = projects.find(p => p.number === 1) || projects.find(p => p.title === '이슈관리');

            if (!targetProject) {
              console.log('프로젝트 #1 또는 "이슈관리"를 찾을 수 없습니다.');
              console.log(`사용 가능한 프로젝트: ${projects.map(p => `#${p.number} ${p.title}`).join(', ')}`);
              return;
            }

            console.log(`대상 프로젝트: #${targetProject.number} ${targetProject.title}`);

            // 이슈가 이미 프로젝트에 있는지 확인
            let itemId = null;

            try {
              const issueQuery = `
                query($issueNodeId: ID!) {
                  node(id: $issueNodeId) {
                    ... on Issue {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            number
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const issueData = await github.graphql(issueQuery, { issueNodeId });
              const existingItem = issueData.node.projectItems.nodes.find(
                item => item.project.number === 1
              );

              if (existingItem) {
                itemId = existingItem.id;
                console.log(`이슈가 이미 프로젝트에 있음: ${itemId}`);
              }
            } catch (error) {
              console.log('이슈 상태 확인 실패, 프로젝트에 추가 시도');
            }

            // 프로젝트에 없으면 추가
            if (!itemId) {
              const addItemMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;

              try {
                const addResult = await github.graphql(addItemMutation, {
                  projectId: targetProject.id,
                  contentId: issueNodeId
                });
                itemId = addResult.addProjectV2ItemById.item.id;
                console.log(`이슈가 프로젝트에 추가됨: ${itemId}`);
              } catch (error) {
                console.log(`프로젝트 추가 실패: ${error.message}`);
                return;
              }
            }

            // 필드 업데이트 함수
            async function updateField(fieldId, value) {
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(updateMutation, {
                projectId: targetProject.id,
                itemId: itemId,
                fieldId: fieldId,
                value: value
              });
            }

            // 타입 → 에픽
            const typeField = targetProject.fields.nodes.find(f => f.name === '타입');
            if (typeField && typeField.options) {
              const epicOption = typeField.options.find(o => o.name === '에픽');
              if (epicOption) {
                await updateField(typeField.id, { singleSelectOptionId: epicOption.id });
                console.log('✔️ 타입 → 에픽');
              } else {
                console.log(`⚠️ '에픽' 옵션을 찾을 수 없습니다 (사용 가능: ${typeField.options.map(o => o.name).join(', ')})`);
              }
            }

            // Status → 검수대기
            const statusField = targetProject.fields.nodes.find(f => f.name === 'Status');
            if (statusField && statusField.options) {
              const pendingOption = statusField.options.find(o => o.name === '검수대기');
              if (pendingOption) {
                await updateField(statusField.id, { singleSelectOptionId: pendingOption.id });
                console.log('✔️ Status → 검수대기');
              }
            }

            console.log('Epic 프로젝트 필드 설정 완료');
