name: Update Project Status on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  update-status:
    # PRì´ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Update Issue Status to Review Requested
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_PAT }}
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            console.log('ğŸ“‹ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:', pr.html_url);

            // PR ë³¸ë¬¸ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (Related to #123 íŒ¨í„´)
            const issueMatch = prBody.match(/Related to #(\d+)/i);

            if (!issueMatch) {
              console.log('âš ï¸ PR ë³¸ë¬¸ì—ì„œ ê´€ë ¨ ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            const issueNumber = parseInt(issueMatch[1]);
            console.log(`ğŸ” ê´€ë ¨ ì´ìŠˆ: #${issueNumber}`);

            try {
              // 1. ì´ìŠˆê°€ ì†í•œ í”„ë¡œì íŠ¸ ì•„ì´í…œ ì°¾ê¸°
              const projectQuery = `
                query($org: String!, $projectNumber: Int!, $issueNumber: Int!, $repo: String!) {
                  organization(login: $org) {
                    projectV2(number: $projectNumber) {
                      id
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              repository {
                                name
                              }
                            }
                          }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                id
                                name
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    id
                                    name
                                    options {
                                      id
                                      name
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectData = await github.graphql(projectQuery, {
                org: 'semicolon-devteam',
                projectNumber: 1,
                issueNumber: issueNumber,
                repo: context.repo.repo
              });

              const project = projectData.organization.projectV2;
              const projectItem = project.items.nodes.find(item => {
                return item.content &&
                       item.content.number === issueNumber &&
                       item.content.repository.name === context.repo.repo;
              });

              if (!projectItem) {
                console.log('âš ï¸ í”„ë¡œì íŠ¸ì—ì„œ í•´ë‹¹ ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              console.log(`âœ… í”„ë¡œì íŠ¸ ì•„ì´í…œ ì°¾ìŒ: ${projectItem.id}`);

              // 2. Status í•„ë“œ ì°¾ê¸°
              const statusFieldValue = projectItem.fieldValues.nodes.find(
                fv => fv.field && fv.field.name === 'Status'
              );

              if (!statusFieldValue || !statusFieldValue.field) {
                console.log('âš ï¸ Status í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              const statusField = statusFieldValue.field;
              const currentStatus = statusFieldValue.name;

              console.log(`í˜„ì¬ Status: "${currentStatus}"`);

              // 3. 'ë¦¬ë·°ìš”ì²­' ì˜µì…˜ ID ì°¾ê¸°
              const reviewRequestedOption = statusField.options.find(
                opt => opt.name === 'ë¦¬ë·°ìš”ì²­'
              );

              if (!reviewRequestedOption) {
                console.log('âš ï¸ "ë¦¬ë·°ìš”ì²­" Status ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì˜µì…˜:', statusField.options.map(o => o.name).join(', '));
                return;
              }

              console.log(`"ë¦¬ë·°ìš”ì²­" ì˜µì…˜ ID: ${reviewRequestedOption.id}`);

              // 4. Status ì—…ë°ì´íŠ¸
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(updateMutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                optionId: reviewRequestedOption.id
              });

              console.log(`âœ… Statusë¥¼ "${currentStatus}" â†’ "ë¦¬ë·°ìš”ì²­"ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);

              // 5. ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ‰ PR #${pr.number}ì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní”„ë¡œì íŠ¸ Statusê°€ "ë¦¬ë·°ìš”ì²­"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë·°ì–´ì˜ ê²€ìˆ˜ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`
              });

              console.log('âœ… ì´ìŠˆì— ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
              console.error('âŒ Status ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

              // ì—ëŸ¬ ì‹œì—ë„ ì´ìŠˆì— ì•Œë¦¼
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ PR #${pr.number}ì´ ë¨¸ì§€ë˜ì—ˆìœ¼ë‚˜, Status ìë™ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nìˆ˜ë™ìœ¼ë¡œ Statusë¥¼ "ë¦¬ë·°ìš”ì²­"ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.\n\nì—ëŸ¬: ${error.message}`
              });
            }
